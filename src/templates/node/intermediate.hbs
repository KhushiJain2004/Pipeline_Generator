name: CI
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build_test:
    runs-on: ubuntu-latest
    {{#if matrix.node_versions}}
    strategy:
      matrix:
        node: [{{#each matrix.node_versions}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}]
    {{/if}}
    steps:
      - uses: actions/checkout@v4
      {{> gha/setup-node this}}
      {{> gha/cache-npm this}}
      {{> gha/step-lint this}}
      {{> gha/step-test this}}
      {{> gha/step-build this}}
      {{> gha/step-artifact this}}

  {{#if container.enabled}}
  docker_build:
    runs-on: ubuntu-latest
    needs: build_test
    permissions:
      contents: read
      {{#if (eq container.registry "ghcr.io")}}packages: write{{/if}}
      id-token: write
    steps:
      - uses: actions/checkout@v4
      {{> gha/docker-login this}}
      {{> gha/docker-meta this}}
      {{> gha/docker-build-push this}}
  {{/if}}
